# hc-sky-runner - test/test-app.coffee
# Copyright(c) 2014 Alibaba.com
# Author: jifeng.zjd <jifeng.zjd@alibaba-inc.com>

path = require 'path'
e  = require 'expect.js'
Runner = require '../index'
request = require 'request'

describe 'app', ()->
  it 'config success', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_config'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err).to.eql(null)
      e(info.runner).to.eql('hc-sky-runner@0.0.1')
      request.get "http://127.0.0.1:#{port}", (err, _res, body)->
        e(err).to.eql(null)
        e(body).to.eql('hello world')
        done()

  it 'etc defulat config success', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_etc_default_config'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err).to.eql(null)
      e(info.runner).to.eql('hc-sky-runner@0.0.1')
      request.get "http://127.0.0.1:#{port}", (err, _res, body)->
        e(err).to.eql(null)
        e(body).to.eql('hello world')
        done()


  it 'etc config success', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_etc_config'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err).to.eql(null)
      e(info.runner).to.eql('hc-sky-runner@0.0.1')
      request.get "http://127.0.0.1:#{port}", (err, _res, body)->
        e(err).to.eql(null)
        e(body).to.eql('http hello world')
        done()

  it 'app not exist fail', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_not_exist_config'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err.message).to.contain('App File NOT Found')
      done()



  it 'app config err fail', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_etc_err_config'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err.message).to.contain('Read App Config Error')
      done()


  it 'app config empty fail', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_empty_config'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err.message).to.contain('Read App Config Error')
      done()


  it 'app mock ready err', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_ready_err'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err.message).to.contain('mock err')
      done()

  it 'app mock ready err Cannot find module', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_empty_code'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err.message).to.contain('Cannot find module')
      done()


  it 'app mock ready err Cannot find module', (done)->
    port = Math.floor(Math.random()* 9000 + 1000)
    dir = path.join __dirname, './mock/app_empty_code2'
    runner = Runner dir: dir
    runner.sock = port
    runner.run (err, info)->
      e(err.message).to.contain('Cannot find module')
      done()